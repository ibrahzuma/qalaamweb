{% extends 'base.html' %}

{% block title %}Prayer Times & Hijri Calendar - QALAAM{% endblock %}

{% block extra_css %}
<style>
    .prayer-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        border-radius: 15px;
        overflow: hidden;
    }

    .prayer-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .prayer-time {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .next-prayer {
        background: linear-gradient(135deg, var(--primary-color), #004d43);
        color: white;
    }

    .hijri-section {
        background-color: var(--secondary-color);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 text-center">
        <h2 class="section-title">Prayer Times & Hijri Calendar</h2>
    </div>
</div>

<div class="row justify-content-center mb-5">
    <div class="col-md-8">
        <div class="hijri-section text-center shadow-sm">
            <h4 class="text-muted mb-2">Today's Date</h4>
            <h2 id="hijri-date" class="fw-bold mb-1">Loading Hijri Date...</h2>
            <p id="gregorian-date" class="text-muted fs-5"></p>
            <div id="location-display" class="small text-primary mt-2">
                <i class="bi bi-geo-alt-fill"></i> <span id="city-name">Detecting location...</span>
            </div>
        </div>
    </div>
</div>

<div id="prayer-container" class="row row-cols-1 row-cols-md-3 row-cols-lg-6 g-4 mb-5">
    <!-- Fajr -->
    <div class="col">
        <div class="card prayer-card h-100 shadow-sm" id="card-Fajr">
            <div class="card-body text-center p-4">
                <h5 class="card-title text-muted">Fajr</h5>
                <div class="prayer-time" id="time-Fajr">--:--</div>
            </div>
        </div>
    </div>
    <!-- Dhuhr -->
    <div class="col">
        <div class="card prayer-card h-100 shadow-sm" id="card-Dhuhr">
            <div class="card-body text-center p-4">
                <h5 class="card-title text-muted">Dhuhr</h5>
                <div class="prayer-time" id="time-Dhuhr">--:--</div>
            </div>
        </div>
    </div>
    <!-- Asr -->
    <div class="col">
        <div class="card prayer-card h-100 shadow-sm" id="card-Asr">
            <div class="card-body text-center p-4">
                <h5 class="card-title text-muted">Asr</h5>
                <div class="prayer-time" id="time-Asr">--:--</div>
            </div>
        </div>
    </div>
    <!-- Maghrib -->
    <div class="col">
        <div class="card prayer-card h-100 shadow-sm" id="card-Maghrib">
            <div class="card-body text-center p-4">
                <h5 class="card-title text-muted">Maghrib</h5>
                <div class="prayer-time" id="time-Maghrib">--:--</div>
            </div>
        </div>
    </div>
    <!-- Isha -->
    <div class="col">
        <div class="card prayer-card h-100 shadow-sm" id="card-Isha">
            <div class="card-body text-center p-4">
                <h5 class="card-title text-muted">Isha</h5>
                <div class="prayer-time" id="time-Isha">--:--</div>
            </div>
        </div>
    </div>
    <!-- Sunrise (Optional but good) -->
    <div class="col">
        <div class="card prayer-card h-100 shadow-sm" id="card-Sunrise">
            <div class="card-body text-center p-4">
                <h5 class="card-title text-muted">Sunrise</h5>
                <div class="prayer-time" id="time-Sunrise">--:--</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 text-center text-muted small">
        <p>Calculated using the Aladhan API. Times are based on your detected location.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(success, error);
        } else {
            // Default to Mecca if geolocation not supported
            fetchPrayerTimes(21.4225, 39.8262, "Mecca (Default)");
        }

        function success(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            fetchPrayerTimes(lat, lng, "Detected Location");
        }

        function error() {
            // Default to Mecca if geolocation failed/denied
            fetchPrayerTimes(21.4225, 39.8262, "Mecca (Default - Location Access Denied)");
        }

        async function fetchPrayerTimes(lat, lng, locationLabel) {
            const cityDisplay = document.getElementById('city-name');
            cityDisplay.textContent = locationLabel;

            try {
                const response = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lng}&method=2`);
                const data = await response.json();

                if (data.code === 200) {
                    const timings = data.data.timings;
                    const hijri = data.data.date.hijri;
                    const gregorian = data.data.date.gregorian;

                    // Update Hijri Date
                    document.getElementById('hijri-date').textContent = `${hijri.day} ${hijri.month.en} ${hijri.year} AH`;
                    document.getElementById('gregorian-date').textContent = gregorian.date;

                    // Update Prayer Times
                    const prayers = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                    prayers.forEach(prayer => {
                        document.getElementById(`time-${prayer}`).textContent = timings[prayer];
                    });

                    highlightNextPrayer(timings);
                }
            } catch (err) {
                console.error("Error fetching prayer times:", err);
            }
        }

        function highlightNextPrayer(timings) {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();

            const prayers = [
                { name: 'Fajr', time: timings.Fajr },
                { name: 'Sunrise', time: timings.Sunrise },
                { name: 'Dhuhr', time: timings.Dhuhr },
                { name: 'Asr', time: timings.Asr },
                { name: 'Maghrib', time: timings.Maghrib },
                { name: 'Isha', time: timings.Isha }
            ];

            let nextPrayer = null;

            for (let prayer of prayers) {
                const [hours, minutes] = prayer.time.split(':').map(Number);
                const prayerMinutes = hours * 60 + minutes;

                if (prayerMinutes > currentTime) {
                    nextPrayer = prayer.name;
                    break;
                }
            }

            if (!nextPrayer) nextPrayer = 'Fajr'; // If all passed, next is Fajr tomorrow

            document.getElementById(`card-${nextPrayer}`).classList.add('next-prayer');
            document.getElementById(`time-${nextPrayer}`).style.color = 'white';
            const title = document.querySelector(`#card-${nextPrayer} .card-title`);
            title.classList.remove('text-muted');
            title.style.color = 'rgba(255,255,255,0.8)';
            title.textContent += " (Next)";
        }
    });
</script>
{% endblock %}